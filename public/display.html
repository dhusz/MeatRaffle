<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Meat Raffle Display</title>
    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            background: darkgreen;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            font-family: sans-serif;
            color: white;
        }

        #message {
            position: absolute;
            top: 2%;
            width: 100%;
            text-align: center;
            font-size: 3vw;
        }

        /* Main card container */
        #cardContainer {
            perspective: 1500px;
            display: none;
            position: relative;
            flex-shrink: 0;
            width: 40vmin;
            height: 56vmin;
            /* 7:10 aspect ratio */
            margin-top: 5vh;
        }

        .card {
            width: 100%;
            height: 100%;
            position: absolute;
            transform-style: preserve-3d;
            transform: rotateY(0deg);
            transition: transform 0.8s ease-in-out;
        }

        .face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 10px;
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.5);
            background-size: cover;
            background-position: center;
        }

        .back {
            background-image: url('https://deckofcardsapi.com/static/img/back.png');
        }

        .front {
            transform: rotateY(180deg);
        }

        /* Spin + grow animation */
        @keyframes spinGrow {
            0% {
                transform: scale(0.1) rotate(0deg);
                opacity: 0;
            }

            70% {
                transform: scale(1.1) rotate(1080deg);
                opacity: 1;
            }

            100% {
                transform: scale(1) rotate(1080deg);
                opacity: 1;
            }
        }

        .animateEntrance {
            animation: spinGrow 2s ease-out forwards;
        }

        /* Shrink-out animation */
        .shrink {
            transition: transform 0.6s ease-in-out, opacity 0.6s ease-in-out;
            transform: scale(0);
            opacity: 0;
        }

        /* Bottom history panel */
        #history {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            display: flex;
            flex-wrap: nowrap;
            overflow-x: auto;
            justify-content: flex-start;
            background: rgba(0, 0, 0, 0.3);
            padding: 15px 0;
            /* larger row */
            box-sizing: border-box;
        }

        #history img {
            width: 100px;
            height: auto;
            margin: 0 10px;
            border-radius: 5px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.5);
        }

        /* Portrait orientation: auto-scale card to fill available vertical space */
        @media screen and (orientation: portrait) {
            #cardContainer {
                height: calc(100vh - 130px);
                /* leave space for history row */
                width: calc((100vh - 130px) * 0.714);
                /* maintain 7:10 aspect ratio */
            }
        }
    </style>
</head>

<body>
    <div id="message">Waiting for card...</div>

    <div id="cardContainer">
        <div id="card" class="card">
            <div class="face back"></div>
            <img id="cardFront" class="face front" src="" alt="card front">
        </div>
    </div>

    <div id="history"></div>

    <script>
        let ws;
        const cardContainer = document.getElementById('cardContainer');
        const card = document.getElementById('card');
        const cardFront = document.getElementById('cardFront');
        const msg = document.getElementById('message');
        const historyDiv = document.getElementById('history');

        function connectWebSocket(){
            ws = new WebSocket('ws://localhost:8080');

            ws.onopen = () => {
                console.log("✅ Connected to server");
                ws.send(JSON.stringify({type: 'syncRequest'}));
            }

            ws.onclose = () => {
                console.warn("⚠️ Disconnected.  Retrying...");
                setTimeout(connectWebSocket, 1500);
            }

            ws.onmessage = handleMessage;
        }

        connectWebSocket();

        async function handleMessage(e){
            let data;
            try { data = JSON.parse(e.data); }
            catch { console.error('Bad JSON', e.data); return; }

            console.log('message', data);

            switch(data.type){
                case 'card':
                    showCard(data.currentCard.image);
                    break;
                case 'undo':
                    await shrinkCard();
                    updateHistory(data.history);
                    if (data.currentCard?.image) {
                        showCard(data.currentCard.image, true);
                    }
                    break;
                case 'reset':
                    resetDisplay();
                    break;
                case 'history':
                    updateHistory(data.history);
                    break;
                case 'syncState':
                    updateHistory(data.history);
                    if(data.currentCard?.image){
                        showCard(data.currentCard.image, true);
                    }
                    else{
                        resetDisplay();
                    }
                    break;
                default:
                    break;
            }
        };

        function showCard(image, instant = false){
            msg.style.display = 'none';
            cardContainer.style.display = 'block';
            cardFront.src = image;
            card.style.transform = 'rotateY(0deg) scale(0.1)'
            void card.offsetWidth; // force reflow

            if(!instant){
                card.classList.add('animateEntrance');
                setTimeout(() => {
                    card.classList.remove('animateEntrance');
                    card.style.transform = 'rotateY(180deg)';
                }, 2200);
            } else {
                card.style.transform = 'rotateY(180deg)'
            }
        }

        async function shrinkCard() {
            // Animate shrink away (do NOT show previous card)
            card.classList.add('shrink');
            await new Promise(r => setTimeout(r, 600));

            // Hide and reset
            cardContainer.style.display = 'none';
            card.classList.remove('shrink');
            card.style.transform = 'rotateY(0deg)';
            cardFront.src = '';

            // Show message
            msg.style.display = 'block';
            msg.textContent = 'Last card taken back...';
        }

        function resetDisplay() {
            cardContainer.style.display = 'none';
            msg.style.display = 'block';
            msg.textContent = 'New game started';
            cardFront.src = '';
        }

        function updateHistory(history) {
            historyDiv.innerHTML = '';
            history.forEach(code => {
                const img = document.createElement('img');
                img.src = `https://deckofcardsapi.com/static/img/${code}.png`;
                historyDiv.appendChild(img);
            });
        }
    </script>
</body>

</html>